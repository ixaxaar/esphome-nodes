esphome:
  name: lilygo-tqt-lowbatt
  friendly_name: LILYGO T-QT Display
  on_boot:
    priority: -100
    then:
      - lambda: |-
          // Get the default screen and clear it
          auto screen = lv_scr_act();
          lv_obj_clean(screen);  // Clear any default content

          // Set screen background to black
          lv_obj_set_style_bg_color(screen, lv_color_make(0, 0, 0), LV_PART_MAIN | LV_STATE_DEFAULT);
          lv_obj_set_style_bg_opa(screen, LV_OPA_COVER, LV_PART_MAIN | LV_STATE_DEFAULT);

          // Create main container
          auto container = lv_obj_create(screen);
          lv_obj_set_size(container, 128, 128);  // Full screen size
          lv_obj_center(container);

          // Remove container's default background and border
          lv_obj_set_style_bg_opa(container, LV_OPA_TRANSP, LV_PART_MAIN | LV_STATE_DEFAULT);
          lv_obj_set_style_border_width(container, 0, LV_PART_MAIN | LV_STATE_DEFAULT);

          // Create time label using built-in LVGL fonts
          auto time_label = lv_label_create(container);
          lv_obj_set_style_text_font(time_label, &lv_font_montserrat_20, LV_STATE_DEFAULT);
          lv_obj_set_style_text_color(time_label, lv_color_make(0xFF, 0xFF, 0xFF), LV_STATE_DEFAULT);
          lv_obj_center(time_label);  // Center in container
          lv_obj_align(time_label, LV_ALIGN_CENTER, 0, -15);
          lv_label_set_text(time_label, "00:00");

          // Create date label
          auto date_label = lv_label_create(container);
          lv_obj_set_style_text_font(date_label, &lv_font_montserrat_14, LV_STATE_DEFAULT);
          lv_obj_set_style_text_color(date_label, lv_color_make(0xFF, 0xFF, 0xFF), LV_STATE_DEFAULT);
          lv_obj_align(date_label, LV_ALIGN_CENTER, 0, 15);
          lv_label_set_text(date_label, "00-00-0000");

          // Store label references for updates
          id(time_label_obj) = time_label;
          id(date_label_obj) = date_label;

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: arduino

# Enable logging
logger:

# Enable Home Assistant API
api:

ota:
  - platform: esphome
    password: "***REMOVED***"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Lilygo-Tqt Fallback Hotspot"
    password: "your_fallback_password"

# Sync time with NTP
time:
  - platform: sntp
    id: sntp_time
    timezone: "Asia/Kolkata"

# Define the SPI display with correct pins
spi:
  clk_pin: GPIO3 # PIN_D5 (SCLK)
  mosi_pin: GPIO2 # PIN_D7 (MOSI)
  miso_pin: GPIO12 # PIN_D6 (MISO)

lvgl:
  id: lvgl_1

# Primary display driver
display:
  - platform: ili9xxx
    model: gc9a01a
    id: ili9xxx_display
    cs_pin: GPIO5 # PIN_D8 (CS)
    dc_pin: GPIO6 # PIN_D3 (DC)
    reset_pin: GPIO1 # PIN_D4 (RST)
    transform:
      mirror_x: true
      mirror_y: true
    invert_colors: true
    auto_clear_enabled: false

font:
  - file: "gfonts://Roboto"
    id: font1
    size: 14

  - file: "gfonts://Pattaya"
    id: font2
    size: 28

# Store references to LVGL label objects
globals:
  - id: time_label_obj
    type: lv_obj_t*
    restore_value: no
  - id: date_label_obj
    type: lv_obj_t*
    restore_value: no

# Update the clock every second
interval:
  - interval: 1s
    then:
      - lambda: |-
          auto time = id(sntp_time).now();
          if (time.is_valid()) {
            char time_str[6];
            sprintf(time_str, "%02d:%02d", time.hour, time.minute);
            lv_label_set_text(id(time_label_obj), time_str);

            char date_str[11];
            sprintf(date_str, "%02d-%02d-%04d", time.day_of_month, time.month, time.year);
            lv_label_set_text(id(date_label_obj), date_str);
          }

binary_sensor:
  - platform: gpio
    pin: GPIO16 # PIN_D0 (WAKE)
    name: "Button"
    on_press:
      # Define action on button press if needed
      - logger.log: "Button pressed"
